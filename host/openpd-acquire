#!/usr/bin/python

import time
import argparse
import openpd
import sys

parser = argparse.ArgumentParser(description='Periodically poll photodiode for power samples')
parser.add_argument('-t', '--timestamps', action='store_true', help='Emit timestamps with samples')
parser.add_argument('-n', '--period', type=float, default=0.5, help='Sampling period in seconds')
parser.add_argument('-d', '--device', type=argparse.FileType('r'), help='Name of serial device')
parser.add_argument('-r', '--raw', action='store_true', help="Don't use daemon")
parser.add_argument('-o', '--output', type=argparse.FileType('w'), default=sys.stdout,
                    help='Output file')
args = parser.parse_args()

if not args.raw:
    conn = openpd.Connection()
    if args.device is None:
        devices = conn.list_devices()
        if len(devices) == 0:
            raise RuntimeError('Daemon knows of no devices')
        meter = conn.device(devices[0])
    else:
        meter = conn.device(args.device.name)
else:
    if args.device is None:
	raise RuntimeError('Must specify device path when running with --raw')
    meter = openpd.RawOpenPD(args.device.name)

output = args.output
while True:
    power = meter.sample()['power']
    if args.timestamps:
        output.write('%f\t%g\n' % (time.time(), power))
    else:
        output.write('%g\n' % power)

    output.flush()
    time.sleep(args.period)
